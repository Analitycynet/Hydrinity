From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mykyta Komarnytskyy <nkomarn@hotmail.com>
Date: Wed, 7 Oct 2020 16:54:50 -0700
Subject: [PATCH] Cache recipe lookups

Store recipes in a cache to speed up future lookups, as well as replace a stream in craft() to increase execution speed.

This patch was originally created for the Yatopia <https://github.com/YatopiaMC/Yatopia> project by Mykyta Komarnytskyy <nkomarn@hotmail.com> under the MIT license.

diff --git a/src/main/java/net/minecraft/server/CraftingManager.java b/src/main/java/net/minecraft/server/CraftingManager.java
index 58ecbe1e20581dc9e78cdd2f4ece29cfa014da8a..d61d22138e6feed85c8f1e360febb845db1268c0 100644
--- a/src/main/java/net/minecraft/server/CraftingManager.java
+++ b/src/main/java/net/minecraft/server/CraftingManager.java
@@ -31,6 +31,9 @@ public class CraftingManager extends ResourceDataJson {
     private static final Logger LOGGER = LogManager.getLogger();
     public Map<Recipes<?>, Object2ObjectLinkedOpenHashMap<MinecraftKey, IRecipe<?>>> recipes = ImmutableMap.of(); // CraftBukkit
     private boolean d;
+    // Hydrinity start
+    private static final Map<Recipes<?>, List<IRecipe<?>>> RECIPE_CACHE = new Object2ObjectLinkedOpenHashMap<>();
+    // Hydrinity end
 
     public CraftingManager() {
         super(CraftingManager.a, "recipes");
@@ -84,18 +87,29 @@ public class CraftingManager extends ResourceDataJson {
 
     public <C extends IInventory, T extends IRecipe<C>> Optional<T> craft(Recipes<T> recipes, C c0, World world) {
         // CraftBukkit start
-        Optional<T> recipe = this.b(recipes).values().stream().flatMap((irecipe) -> {
-            return SystemUtils.a(recipes.a(irecipe, world, c0));
-        }).findFirst();
+        // Hydrinity start - replace stream
+        Collection<IRecipe<C>> allTypes = this.b(recipes).values();
+        Optional<T> recipe = Optional.empty();
+
+        for (IRecipe<C> possible : allTypes) {
+            Optional<T> possibleRecipe = recipes.a(possible, world, c0);
+            if (possibleRecipe.isPresent()) {
+                recipe = possibleRecipe;
+                break;
+            }
+        }
+        // Hydrinity end
         c0.setCurrentRecipe(recipe.orElse(null)); // CraftBukkit - Clear recipe when no recipe is found
         // CraftBukkit end
         return recipe;
     }
 
     public <C extends IInventory, T extends IRecipe<C>> List<T> a(Recipes<T> recipes) {
-        return (List) this.b(recipes).values().stream().map((irecipe) -> {
-            return irecipe;
-        }).collect(Collectors.toList());
+        // Hydrinity start - use recipe cache when possible
+        return (List) RECIPE_CACHE.computeIfAbsent(recipes, recipes1 -> {
+           return new java.util.ArrayList<>(this.b(recipes).values());
+        });
+        // Hydrinity end
     }
 
     public <C extends IInventory, T extends IRecipe<C>> List<T> b(Recipes<T> recipes, C c0, World world) {
